{% extends 'base.html' %}
{% block title %}Profil ‚Äî {{ user.username }}{% endblock %}

{% block extra_css %}
.profile-page {
    max-width: 900px; margin: 0 auto; padding: 48px 5%;
}

/* Header */
.profile-header {
    display: flex; align-items: center; gap: 32px;
    padding-bottom: 40px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 48px;
}
.profile-avatar {
    width: 100px; height: 100px; border-radius: 50%;
    overflow: hidden; flex-shrink: 0;
    background: var(--surface2);
    display: flex; align-items: center; justify-content: center;
    font-size: 2.5rem;
    border: 3px solid var(--border);
}
.profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
.profile-info h1 {
    font-family: var(--font-display);
    font-size: 2rem; font-weight: 900;
    color: var(--white); letter-spacing: -1px;
}
.profile-info .username { color: var(--text-muted); margin-top: 4px; font-size: 0.95rem; }
.profile-info .bio { color: var(--text); margin-top: 10px; line-height: 1.6; }
.profile-stats { display: flex; gap: 28px; margin-top: 16px; }
.profile-stat .num { font-size: 1.3rem; font-weight: 700; color: var(--white); }
.profile-stat .label { font-size: 0.78rem; color: var(--text-muted); margin-top: 2px; }

/* Tabs */
.tabs {
    display: flex; gap: 4px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 36px;
}
.tab-btn {
    padding: 10px 20px; background: none; border: none;
    color: var(--text-muted); font-family: var(--font-body);
    font-size: 0.9rem; font-weight: 500; cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s; margin-bottom: -1px;
}
.tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab-btn:hover { color: var(--text); }

.tab-panel { display: none; }
.tab-panel.active { display: block; animation: fadeUp 0.25s ease; }
@keyframes fadeUp { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

/* Edit form */
.form-section { margin-bottom: 32px; }
.form-section-title {
    font-size: 0.75rem; font-weight: 700; letter-spacing: 1.5px;
    text-transform: uppercase; color: var(--text-muted);
    margin-bottom: 16px; padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
}
.form-group { margin-bottom: 18px; }
.form-label {
    display: block; font-size: 0.8rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--text-muted); margin-bottom: 7px;
}
.form-field input, .form-field textarea {
    width: 100%; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 10px;
    padding: 11px 15px; color: var(--text);
    font-family: var(--font-body); font-size: 0.95rem;
    outline: none; transition: border-color 0.2s;
    box-sizing: border-box; resize: vertical;
}
.form-field input:focus, .form-field textarea:focus { border-color: var(--accent); }
.form-field input::placeholder, .form-field textarea::placeholder { color: var(--text-muted); }

.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

/* Avatar upload */
.avatar-upload { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
.avatar-preview {
    width: 72px; height: 72px; border-radius: 50%;
    overflow: hidden; background: var(--surface2);
    border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.8rem; flex-shrink: 0;
}
.avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
.upload-btn {
    padding: 9px 18px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-family: var(--font-body);
    font-size: 0.875rem; cursor: pointer; transition: all 0.2s;
}
.upload-btn:hover { border-color: var(--accent); color: var(--accent); }
input[type="file"] { display: none; }

.save-btn {
    padding: 12px 32px; background: var(--accent); color: #0a0a0f;
    border: none; border-radius: 10px; font-family: var(--font-body);
    font-size: 0.95rem; font-weight: 700; cursor: pointer; transition: all 0.2s;
}
.save-btn:hover { background: #f5d080; transform: translateY(-1px); }

/* Posts grid */
.my-posts-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 20px;
}
.my-post-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; overflow: hidden;
    transition: border-color 0.2s, transform 0.2s;
}
.my-post-card:hover { border-color: var(--accent); transform: translateY(-3px); }
.my-post-img { height: 140px; background: var(--surface2); overflow: hidden; }
.my-post-img img { width: 100%; height: 100%; object-fit: cover; }
.no-img { width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:2rem; }
.my-post-body { padding: 16px; }
.my-post-title {
    font-family: var(--font-display); font-size: 1rem; font-weight: 700;
    color: var(--white); text-decoration: none; display: block; line-height: 1.3;
}
.my-post-title:hover { color: var(--accent); }
.my-post-meta { font-size: 0.78rem; color: var(--text-muted); margin-top: 8px; display: flex; justify-content: space-between; }
.status-badge {
    display: inline-block; padding: 2px 8px; border-radius: 20px;
    font-size: 0.7rem; font-weight: 600;
}
.status-published { background: #0d2a1a; color: #50c878; }
.status-draft { background: #1a1a0d; color: #c8c850; }

.post-actions { display: flex; gap: 8px; margin-top: 10px; }
.action-link {
    font-size: 0.78rem; color: var(--text-muted); text-decoration: none;
    padding: 3px 8px; border-radius: 5px; border: 1px solid var(--border);
    transition: all 0.2s;
}
.action-link:hover { color: var(--accent); border-color: var(--accent); }
.action-link.danger:hover { color: var(--danger); border-color: var(--danger); }

.empty-state { text-align: center; padding: 60px 0; color: var(--text-muted); }
.empty-state .icon { font-size: 3rem; margin-bottom: 12px; }

@media (max-width: 600px) {
    .profile-header { flex-direction: column; text-align: center; }
    .profile-stats { justify-content: center; }
    .form-grid { grid-template-columns: 1fr; }
}
{% endblock %}

{% block content %}
<div class="profile-page">

    <!-- Profile Header -->
    <div class="profile-header">
        <div class="profile-avatar">
            {% if user.profile.avatar %}
                <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}">
            {% else %}üë§{% endif %}
        </div>
        <div class="profile-info">
            <h1>{{ user.get_full_name|default:user.username }}</h1>
            <div class="username">@{{ user.username }} ¬∑ {{ user.email }}</div>
            {% if user.profile.bio %}
                <div class="bio">{{ user.profile.bio }}</div>
            {% endif %}
            <div class="profile-stats">
                <div class="profile-stat">
                    <div class="num">{{ user.posts.count }}</div>
                    <div class="label">Post</div>
                </div>
                <div class="profile-stat">
                    <div class="num">{{ user.comments.count }}</div>
                    <div class="label">Izoh</div>
                </div>
                <div class="profile-stat">
                    <div class="num">{{ user.date_joined|date:"Y" }}</div>
                    <div class="label">A'zo bo'lgan</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('posts')">üìù Mening postlarim</button>
        <button class="tab-btn" onclick="switchTab('edit')">‚öôÔ∏è Profilni tahrirlash</button>
    </div>

    <!-- Tab: My Posts -->
    <div class="tab-panel active" id="tab-posts">
        {% with posts=user.posts.all %}
        {% if posts %}
        <div class="my-posts-grid">
            {% for post in posts %}
            <div class="my-post-card">
                <div class="my-post-img">
                    {% if post.cover_image %}
                        <img src="{{ post.cover_image.url }}" alt="">
                    {% else %}
                        <div class="no-img">üìù</div>
                    {% endif %}
                </div>
                <div class="my-post-body">
                    <a class="my-post-title" href="{{ post.get_absolute_url }}">{{ post.title }}</a>
                    <div class="my-post-meta">
                        <span>{{ post.created_at|date:"d M Y" }}</span>
                        <span class="status-badge status-{{ post.status }}">
                            {% if post.status == 'published' %}Chop etilgan{% else %}Qoralama{% endif %}
                        </span>
                    </div>
                    <div class="post-actions">
                        <a class="action-link" href="{{ post.get_absolute_url }}">Ko'rish</a>
                        <a class="action-link" href="{% url 'post_update' post.slug %}">Tahrirlash</a>
                        <a class="action-link danger" href="{% url 'post_delete' post.slug %}">O'chirish</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="icon">‚úçÔ∏è</div>
            <p>Hali postlar yo'q.</p>
            <a href="{% url 'post_create' %}" class="btn btn-primary" style="margin-top:16px;">Birinchi postni yozing</a>
        </div>
        {% endif %}
        {% endwith %}
    </div>

    <!-- Tab: Edit Profile -->
    <div class="tab-panel" id="tab-edit">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Avatar -->
            <div class="form-section">
                <div class="form-section-title">Profil rasmi</div>
                <div class="avatar-upload">
                    <div class="avatar-preview" id="avatarPreview">
                        {% if user.profile.avatar %}
                            <img src="{{ user.profile.avatar.url }}" id="avatarImg" alt="">
                        {% else %}
                            <span id="avatarEmoji">üë§</span>
                        {% endif %}
                    </div>
                    <div>
                        <label for="avatarInput" class="upload-btn">üì∑ Rasm tanlash</label>
                        <input type="file" id="avatarInput" name="avatar" accept="image/*">
                        <p style="font-size:0.78rem; color:var(--text-muted); margin-top:6px;">JPG, PNG ¬∑ Max 2MB</p>
                    </div>
                </div>
            </div>

            <!-- Personal info -->
            <div class="form-section">
                <div class="form-section-title">Shaxsiy ma'lumotlar</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Ism</label>
                        <div class="form-field">
                            <input type="text" name="first_name"
                                   value="{{ user.first_name }}" placeholder="Ismingiz">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Familiya</label>
                        <div class="form-field">
                            <input type="text" name="last_name"
                                   value="{{ user.last_name }}" placeholder="Familiyangiz">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <div class="form-field">
                        <input type="email" name="email"
                               value="{{ user.email }}" placeholder="email@example.com">
                    </div>
                </div>
            </div>

            <!-- Bio -->
            <div class="form-section">
                <div class="form-section-title">Bio</div>
                <div class="form-group">
                    <div class="form-field">
                        <textarea name="bio" rows="4"
                                  placeholder="O'zingiz haqingizda yozing...">{{ user.profile.bio }}</textarea>
                    </div>
                </div>
            </div>

            <button type="submit" class="save-btn">Saqlash ‚Üí</button>
        </form>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
function switchTab(name) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    event.target.classList.add('active');
}

// Avatar preview
document.getElementById('avatarInput')?.addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = e => {
            const preview = document.getElementById('avatarPreview');
            preview.innerHTML = `<img src="${e.target.result}" id="avatarImg" style="width:100%;height:100%;object-fit:cover;">`;
        };
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %}